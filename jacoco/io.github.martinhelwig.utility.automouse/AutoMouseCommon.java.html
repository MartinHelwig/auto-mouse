<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AutoMouseCommon.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">auto-mouse</a> &gt; <a href="index.source.html" class="el_package">io.github.martinhelwig.utility.automouse</a> &gt; <span class="el_source">AutoMouseCommon.java</span></div><h1>AutoMouseCommon.java</h1><pre class="source lang-java linenums">// SPDX-FileCopyrightText: 2023 Martin Helwig
//
// SPDX-License-Identifier: MIT

package io.github.martinhelwig.utility.automouse;

import java.awt.AWTException;
import java.awt.Desktop;
import java.awt.MouseInfo;
import java.awt.Point;
import java.awt.Robot;
import java.awt.TrayIcon.MessageType;
import java.awt.desktop.UserSessionEvent;
import java.awt.desktop.UserSessionListener;
import java.io.IOException;
import java.util.ResourceBundle;

import javax.management.timer.Timer;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import io.github.martinhelwig.utility.automouse.common.ExcludeFromCodeCoverage;

/**
 * AutoMouseCommon is the common implementation of the
 * {@link AutoMouseInterface}.
 *
 * @author Martin Helwig
 *
 */
public class AutoMouseCommon implements AutoMouseInterface {

    /**
     * The logger.
     *
     * @since 1.0.0
     */
<span class="fc" id="L39">    private static Log logger = LogFactory.getLog(AutoMouseCommon.class);</span>

    /**
     * The reource bundle.
     *
     * @since 1.0.0
     */
<span class="fc" id="L46">    private static ResourceBundle resourceBundle = ResourceBundle</span>
<span class="fc" id="L47">            .getBundle(&quot;io.github.martinhelwig.utility.automouse.languages.&quot;</span>
                    + &quot;ApplicationResources&quot;);
    /**
     * Last location point.
     *
     * @since 1.0.0
     */
<span class="fc" id="L54">    private Point lastLocation = null;</span>

    /**
     * Configuration.
     *
     * @since 1.0.0
     */
<span class="fc" id="L61">    private AutoMouseConfiguration autoMouseConfiguration = null;</span>

    /**
     * Screen locked.
     *
     * @since 1.0.0
     */
<span class="fc" id="L68">    private boolean isScreenLocked = false;</span>

    /**
     * Default constructor.
     *
     * @since 1.0.0
     */
<span class="fc" id="L75">    public AutoMouseCommon() {</span>
<span class="fc" id="L76">        this.lastLocation = MouseInfo.getPointerInfo().getLocation();</span>
<span class="fc" id="L77">        this.autoMouseConfiguration = new AutoMouseConfiguration();</span>
<span class="fc" id="L78">        this.addEventListener();</span>
<span class="fc" id="L79">    }</span>

    /**
     * {@inheritDoc}
     *
     */
    @Override
    public Point moveMouse() throws AWTException {
<span class="fc" id="L87">        Point actualLocation = MouseInfo.getPointerInfo().getLocation();</span>
<span class="fc" id="L88">        logger.debug(&quot;actual location: x=&quot; + actualLocation.x + &quot;, y=&quot;</span>
                + actualLocation.y);
<span class="fc" id="L90">        logger.debug(</span>
                &quot;last location: x=&quot; + lastLocation.x + &quot;, y=&quot; + lastLocation.y);
<span class="pc bpc" id="L92" title="2 of 4 branches missed.">        if (lastLocation.x == actualLocation.x</span>
                &amp;&amp; lastLocation.y == actualLocation.y) {
<span class="fc" id="L94">            this.moveMouse(new Point(1, 1));</span>
<span class="fc" id="L95">            this.moveMouse(new Point(lastLocation.x, lastLocation.y));</span>
        }
<span class="fc" id="L97">        lastLocation = actualLocation;</span>
<span class="fc" id="L98">        return actualLocation;</span>
    }

    /**
     * {@inheritDoc}
     *
     */
    @Override
    public Point moveMouse(final Point point) throws AWTException {
<span class="fc" id="L107">        Robot robot = new Robot();</span>
<span class="fc" id="L108">        robot.mouseMove(point.x, point.y);</span>
<span class="fc" id="L109">        logger.debug(&quot;mouse moved to x=&quot; + point.x + &quot;, y=&quot; + point.y);</span>
<span class="fc" id="L110">        return point;</span>
    }

    /**
     * {@inheritDoc}
     *
     */
    @Override
    public void pushMessage(final String message,
            final MessageType messageType) {
<span class="pc bpc" id="L120" title="1 of 5 branches missed.">        switch (messageType) {</span>
        case ERROR:
<span class="fc" id="L122">            logger.error(message);</span>
<span class="fc" id="L123">            break;</span>
        case WARNING:
<span class="fc" id="L125">            logger.warn(message);</span>
<span class="fc" id="L126">            break;</span>
        case INFO:
<span class="fc" id="L128">            logger.info(message);</span>
<span class="fc" id="L129">            break;</span>
        case NONE:
<span class="fc" id="L131">            logger.info(message);</span>
<span class="fc" id="L132">            break;</span>
        default:
<span class="nc" id="L134">            logger.info(message);</span>
        }
<span class="fc" id="L136">    }</span>

    /**
     * {@inheritDoc}
     *
     */
    @Override
    public Point getLastLocation() {
<span class="fc" id="L144">        return this.lastLocation;</span>
    }

    /**
     * {@inheritDoc}
     *
     */
    @Override
    public void run() {
<span class="fc" id="L153">        boolean run = true;</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        while (run) {</span>
            try {
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">                if (!isScreenLocked) {</span>
<span class="fc" id="L157">                    this.moveMouse();</span>
                }
<span class="fc" id="L159">                Thread.sleep(this.autoMouseConfiguration.getTimer()</span>
                        * Timer.ONE_SECOND);
<span class="nc" id="L161">            } catch (Exception e) {</span>
<span class="nc" id="L162">                logger.error(e.getMessage(), e);</span>
<span class="nc" id="L163">                Thread.currentThread().interrupt();</span>
<span class="pc" id="L164">            }</span>
        }
<span class="nc" id="L166">        pushMessage(resourceBundle.getString(&quot;messages.exit&quot;),</span>
                MessageType.ERROR);
<span class="nc" id="L168">    }</span>

    /**
     * {@inheritDoc}
     *
     */
    @Override
    public AutoMouseConfiguration getConfiguration() {
<span class="fc" id="L176">        return this.autoMouseConfiguration;</span>
    }

    /**
     * {@inheritDoc}
     *
     */
    @Override
    public void setCofiguration(final AutoMouseConfiguration configuration)
            throws IOException {
<span class="fc" id="L186">        this.autoMouseConfiguration = configuration;</span>
<span class="fc" id="L187">        configuration.saveConfiguration();</span>
<span class="fc" id="L188">    }</span>

    /**
     * {@inheritDoc}
     *
     */
    @Override
    public boolean isScreenLocked() {
<span class="fc" id="L196">        return this.isScreenLocked;</span>
    }

    /**
     * Adds an AppEventListener to verify if the screen is locked or not.
     *
     * @since 1.0.0
     */
    @ExcludeFromCodeCoverage
    private void addEventListener() {
<span class="fc" id="L206">        Desktop desktop = Desktop.getDesktop();</span>
<span class="fc" id="L207">        desktop.addAppEventListener(new UserSessionListener() {</span>
            @Override @ExcludeFromCodeCoverage
            public void userSessionDeactivated(final UserSessionEvent e) {
<span class="nc" id="L210">                isScreenLocked = true;</span>
<span class="nc" id="L211">            }</span>

            @Override @ExcludeFromCodeCoverage
            public void userSessionActivated(final UserSessionEvent e) {
<span class="nc" id="L215">                isScreenLocked = false;</span>
<span class="nc" id="L216">            }</span>
        });
<span class="fc" id="L218">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>